<!--
    This example shows how the templating engine ("Templater") can be swapped
    out for your own. In this case, we write an adapter for the Handlebars
    templating language. This will incorporate Modulo's built-in filters as
    what Handlebars calls "Helpers". Furthermore, even any custom filters you
    may import will get incorporated as Helpers.

    Use this as a guide for creating your own Templater adaptors to register
    whatever templating engines are useful to your project!
-->
<template Modulo>
    <Script -src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"
          register="engine"
          register-name="HandlebarsTemplater">
        // Using the -src attribute, we load Handlebars to be private within
        // this Script tag (and not pollute the global namespace).

        // Extend the built-in Templater to insert our own code
        class HandlebarsTemplater extends modulo.registry.engines.Templater {
            compile(text) {
                // Followed Handlebar's documentation for precompiling:
                // https://handlebarsjs.com/api-reference/compilation.html
                const code = 'return ' + Handlebars.precompile(text);
                this.Hash = modulo.assets.getHash([], code);
                this.stack = []; // ensure stack is set to empty
                return code;
            }

            render(renderObj) {
                if (!this.handlebarsTemplate) {
                    const spec = this.renderFunc(); // "Rehydrate" spec
                    this.handlebarsTemplate = Handlebars.template(spec);
                    this.hbOptions = { helpers: this.filters };
                }
                const templateCtx = Object.assign({ renderObj }, renderObj);
                return this.handlebarsTemplate(templateCtx, this.hbOptions);
            }
        }
    </Script>

    <Component name="ExampleComponent">
        <Props
            txt
        ></Props>
        <Template engine="HandlebarsTemplater">
            <div>Props work: {{props.txt}}</div>
            {{#unless (first state.data)}}
                <em>First item of data is falsy</em>
            {{/unless}}
            <ul class="people_list">
                <!-- handlebar "helper" syntax can be used for filters -->
                {{#each state.people}}
                    <li>{{upper this}}</li>
                {{/each}}
            </ul>
        </Template>
        <State
            data:='[ null, true, false ]'
            people:='[
                "Ah Sahm",
                "Mai Ling",
                "Young Jun"
            ]'
        ></State>
        <Style>
            li {
                border: 3px solid orange;
                font-size: 30px;
            }
        </Style>
    </Component>

</template>


<script src="https://unpkg.com/mdu.js"></script>

<h1>Custom Template Engine: Handlebars.js Demo</h1>

<hr />
<!-- Finally, instantiate our Handlebars-based component -->
<x-ExampleComponent txt="Hello"></x-ExampleComponent>


<!-- ######################################################################### -->
<!-- # BOILERPLATE FOR MODULO DEMOS    ####################################### -->
<div style="position: absolute; top: 0; right: 0; font-size: 20px; background: #ddd;">
    <a href="https://modulojs.org/demos/">&#x300A; BACK</a> | <a href="#" onclick="
    modulo.fetchQueue.enqueue(String(location.href), text => {
        this.nextSibling.textContent = text;
        window.navigator.clipboard.writeText(text); 
        this.textContent += '  [â˜‘ Copied to clipboard!]';
    })">COPY DEMO</a><pre></pre>
</div>
<!-- ######################################################################### -->


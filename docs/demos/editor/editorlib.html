<script Configuration -src="https://unpkg.com/ace-builds">
    modulo.register('util', function getEditor(elem) {
        ace.config.set('basePath', 'https://unpkg.com/ace-builds/src-min-noconflict');
        return ace.edit(elem);
    });
</script>

<Component name="FileBrowser">
    <Template
        -src="/demos/editor/editorlib/FileBrowser.html"
    ></Template>

    <State
        files:=[]
        all-files:=[]
        chroot
    ></State>

    <Script
        -src="/demos/editor/editorlib/FileBrowser.js"
    ></Script>

    <Style
        -src="/demos/editor/editorlib/FileBrowser.css"
    ></Style>
</Component>

<Component name="Btn">
    <Style
        -src="/demos/editor/editorlib/Btn.css"
    ></Style>
</Component>

<Component name="ModuloEditor">
    <Template>
        <x-EditorSidebar></x-EditorSidebar>
        <x-FileEditor
            content="print('hello world')"
            name="example.py"
        ></x-FileEditor>
    </Template>
    <Style>
        :host {
            --editor-width: 700px;
            display: grid;
            height: calc(100vh - 20px);
            box-sizing: border-box;
            grid-gap: 15px;
            grid-template-columns: 1fr var(--editor-width) 1fr;
        }
        :host * {
            box-sizing: border-box;
        }
    </Style>
</Component>

<Component name="EditorSidebar">
    <Template
        -src="/demos/editor/editorlib/EditorSidebar.html"
    ></Template>
    <State
        visible:=false
        tab:=null
        tabs:=[]
        boxes:=[]
    ></State>
    <Script
        -src="/demos/editor/editorlib/EditorSidebar.js"
    ></Script>
    <Style
        -src="/demos/editor/editorlib/EditorSidebar.css"
    ></Style>
</Component>

<Component name="FileEditor" rerender="manual">
    <Props
        content
        url
        name
        path
        inode
    ></Props>
    <Template>
        <h3>{{ props.name }}</h3>
        {% if state.err %}
            <p><strong>ERR:</strong> {{ state.err }}</p>
        {% elif state.loading %}
            <p><em>Loading...</em></p>
        {% else %}
            <div id="main_editor" [script.edit]>{{ props.content }}</div>
        {% endif %}
    </Template>
    <State
        content=""
        loading:=false
        err:=null
    ></State>
    <Script>
        const { getEditor } = modulo.registry.utils;

        function fetchContent(state, element) {
            state.loading = true;
            fetch(props.url)
                .then(response => response.text())
                .then(text => {
                    state.content = text;
                    state.loading = false;
                    element.rerender();
                })
                .catch(err => {
                    state.err = err;
                    element.rerender();
                });
        }

        function initializedCallback() {
            if (!props.content) {
                state.content = '';
                // TODO: Better support /document multiple editors
                fetchContent(state, element);
            }
        }
        function editMount ({ el }) {
            element.editor = getEditor(el);
            element.editor.setTheme("ace/theme/monokai");
            element.editor.session.setMode("ace/mode/python");
        }

        function editUnmount () {
            element.editor.destroy();
        }
    </Script>
    <Style>
        :host {
            border: 3px solid black;
            padding: 20px;
            display: block;
            width: 100%;
            height: calc(100vh - 20px);
            box-shadow: var(--m-shadow-size) var(--m-shadow-size) 0 var(--m-shadow);
        }

        #main_editor {
            height: 100%;
            width: 100%;
        }

        h3 {
            background: var(--m-black);
            color: var(--m-white);
            padding: 3px;
            margin: -20px;
            font-family: monospace;
            font-weight: lighter;
            margin-bottom: 0;
        }
    </Style>
</Component>

